- mapping: |-
    #!blobl
    root = this
    root.out.origin.agent.name = "Juniper JUNIPER-BFD-MIB"
- switch:
  - check: this.trap.SpecificTrap == 1
    # jnxBfdSessTxIntervalHigh
    #
    # This notification is generated when the threshold value for transmit interval (jnxBfdSessThreshTxInterval) is set
    # and the bfd session transmit interval (jnxBfdSessCurrTxInterval) adapts to a value greater than the threshold
    # value. This trap is sent only once, when we first exceed the threshold. The transmit interval can continue to
    # adapt beyond the threshold value. Adaptation of transmit interval happens due to network issues causing the BFD
    # session to go down on either the local system or the remote neighbor.
    #
    # jnxBfdSessThreshTxInterval (Unsigned32) - The threshold value for transmit interval in microseconds. If the
    #   current transmit interval value adapts to a value greater than the  threshold value, jnxBfdSessTxIntervalHigh
    #   trap is raised.
    # jnxBfdSessCurrTxInterval (Unsigned32) - The current transmit interval in microseconds.
    processors:
      - mapping: |-
          #!blobl
          root = this

          meta varbinds_ok = false
          if this.trap.VarBinds.length() > 1 {
            if this.trap.VarBinds.index(0).OID.has_prefix(".1.3.6.1.4.1.2636.3.45.1.1.1.1.1") {
            if this.trap.VarBinds.index(1).OID.has_prefix(".1.3.6.1.4.1.2636.3.45.1.1.1.1.2") {
              meta varbinds_ok = true
          }}}

      - switch:
        - check: metadata("varbinds_ok")
          processors:
            - mapping: |-
                #!blobl
                root = this

                root.out.juniper.jnxBfdSessThreshTxInterval = this.trap.VarBinds.index(0).Value
                root.out.juniper.jnxBfdSessCurrTxInterval = this.trap.VarBinds.index(1).Value

                root.out.object.name = "BFD-STD-MIB::jnxBfdSessEntry"
                root.out.object.index = this.trap.VarBinds.index(0).OID.snmp_oid_get_index(".1.3.6.1.4.1.2636.3.45.1.1.1.1.1")
                root.out.object.entity = this.trap.AgentAddress.string() + "_" + root.out.object.name + "." + root.out.object.index
                root.out.object.label = "session: bfdSessIndex " + root.out.object.index

                root.out.event.class.name = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessTxIntervalHigh"
                root.out.event.id = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessTxIntervalHigh"
                root.out.event.category.name = "BFD transmit interval threshold"
                root.out.event.message = "BFD Transmit interval, " + root.out.juniper.jnxBfdSessCurrTxInterval.string() + "us, exceeds " + root.out.juniper.jnxBfdSessThreshTxInterval.string() + "us"
                root.out.event.severity.code = 4
                root.out.event.severity.level = "Warning"

            - mapping: |-
                #!blobl
                root = this

                root.out.event.message = if root.out.exists("object.label") {
                  root.out.event.message + "  [ " + root.out.object.label + " ]"
                }

        - processors:
          - mapping: |-
              #!blobl
              root = this

              if this.trap.exists("VarBinds") && this.trap.VarBinds.length() > 0 {
                root.out.snmptrap.varbind.oid_0 = this.trap.VarBinds.index(0).OID
                root.out.snmptrap.varbind.type_0 = this.trap.VarBinds.index(0).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(0).Type == 4 || this.trap.VarBinds.index(0).Type == 68 {
                  root.out.snmptrap.varbind.value_0 = this.trap.VarBinds.index(0).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_0 = this.trap.VarBinds.index(0).Value.string()
                }
              if this.trap.VarBinds.length() > 1 {
                root.out.snmptrap.varbind.oid_1 = this.trap.VarBinds.index(1).OID
                root.out.snmptrap.varbind.type_1 = this.trap.VarBinds.index(1).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(1).Type == 4 || this.trap.VarBinds.index(1).Type == 68 {
                  root.out.snmptrap.varbind.value_1 = this.trap.VarBinds.index(1).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_1 = this.trap.VarBinds.index(1).Value.string()
                }
              if this.trap.VarBinds.length() > 2 {
                root.out.snmptrap.varbind.oid_2 = this.trap.VarBinds.index(2).OID
                root.out.snmptrap.varbind.type_2 = this.trap.VarBinds.index(2).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(2).Type == 4 || this.trap.VarBinds.index(2).Type == 68 {
                  root.out.snmptrap.varbind.value_2 = this.trap.VarBinds.index(2).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_2 = this.trap.VarBinds.index(2).Value.string()
                }
              if this.trap.VarBinds.length() > 3 {
                root.out.snmptrap.varbind.oid_3 = this.trap.VarBinds.index(3).OID
                root.out.snmptrap.varbind.type_3 = this.trap.VarBinds.index(3).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(3).Type == 4 || this.trap.VarBinds.index(3).Type == 68 {
                  root.out.snmptrap.varbind.value_3 = this.trap.VarBinds.index(3).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_3 = this.trap.VarBinds.index(3).Value.string()
                }
              if this.trap.VarBinds.length() > 4 {
                root.out.snmptrap.varbind.oid_4 = this.trap.VarBinds.index(4).OID
                root.out.snmptrap.varbind.type_4 = this.trap.VarBinds.index(4).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(4).Type == 4 || this.trap.VarBinds.index(4).Type == 68 {
                  root.out.snmptrap.varbind.value_4 = this.trap.VarBinds.index(4).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_4 = this.trap.VarBinds.index(4).Value.string()
                }
              }}}}}

              root.out.event.class.name = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessTxIntervalHigh"
              root.out.event.id = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessTxIntervalHigh-unknown"
              root.out.event.category.name = "BFD transmit interval threshold"
              root.out.event.message = "BFD transmit interval threshold exceeded - UNEXPECTED VARBINDS for jnxBfdSessTxIntervalHigh trap!"
              root.out.event.severity.code = 4
              root.out.event.severity.level = "Warning"

  - check: this.trap.SpecificTrap == 2
    # jnxBfdSessDetectionTimeHigh
    #
    # This notification is generated when the threshold value for detection time (jnxBfdSessThreshDectTime) is set and
    # the bfd session detection-time (jnxBfdSessCurrDectTime) adapts to a value greater than the threshold value. This
    # trap is sent only once, when we first exceed the threshold. The detection-time can continue to adapt beyond the
    # threshold value. Adaptation of detection-time happens due to network issues causing the BFD session to go down on
    # either the local system or the remote neighbor.
    #
    # jnxBfdSessThreshDectTime (Unsigned32) - The threshold value for detection time in microseconds. If the current
    #   detection time value is greater than the threshold value at the time when session state changes to up(1),
    #   jnxBfdSessDetectionTimeHigh trap is raised.
    # jnxBfdSessCurrDectTime (Unsigned32) - The actual value of detection time for the session.
    processors:
      - mapping: |-
          #!blobl
          root = this

          meta varbinds_ok = false
          if this.trap.VarBinds.length() > 1 {
            if this.trap.VarBinds.index(0).OID.has_prefix(".1.3.6.1.4.1.2636.3.45.1.1.1.1.3") {
            if this.trap.VarBinds.index(1).OID.has_prefix(".1.3.6.1.4.1.2636.3.45.1.1.1.1.4") {
              meta varbinds_ok = true
          }}}

      - switch:
        - check: metadata("varbinds_ok")
          processors:
            - mapping: |-
                #!blobl
                root = this

                root.out.juniper.jnxBfdSessThreshDectTime = this.trap.VarBinds.index(0).Value
                root.out.juniper.jnxBfdSessCurrDectTime = this.trap.VarBinds.index(1).Value

                root.out.object.name = "BFD-STD-MIB::jnxBfdSessEntry"
                root.out.object.index = this.trap.VarBinds.index(0).OID.snmp_oid_get_index(".1.3.6.1.4.1.2636.3.45.1.1.1.1.3")
                root.out.object.entity = this.trap.AgentAddress.string() + "_" + root.out.object.name + "." + root.out.object.index
                root.out.object.label = "session: bfdSessIndex " + root.out.object.index

                root.out.event.class.name = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessDetectionTimeHigh"
                root.out.event.id = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessDetectionTimeHigh"
                root.out.event.category.name = "BFD session detection-time threshold"
                root.out.event.message = "BFD session detection-time, " + root.out.juniper.jnxBfdSessCurrDectTime.string() + "us, exceeds " + root.out.juniper.jnxBfdSessThreshDectTime.string() + "us"
                root.out.event.severity.code = 4
                root.out.event.severity.level = "Warning"

            - mapping: |-
                #!blobl
                root = this

                root.out.event.message = if root.out.exists("object.label") {
                  root.out.event.message + "  [ " + root.out.object.label + " ]"
                }

        - processors:
          - mapping: |-
              #!blobl
              root = this

              if this.trap.exists("VarBinds") && this.trap.VarBinds.length() > 0 {
                root.out.snmptrap.varbind.oid_0 = this.trap.VarBinds.index(0).OID
                root.out.snmptrap.varbind.type_0 = this.trap.VarBinds.index(0).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(0).Type == 4 || this.trap.VarBinds.index(0).Type == 68 {
                  root.out.snmptrap.varbind.value_0 = this.trap.VarBinds.index(0).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_0 = this.trap.VarBinds.index(0).Value.string()
                }
              if this.trap.VarBinds.length() > 1 {
                root.out.snmptrap.varbind.oid_1 = this.trap.VarBinds.index(1).OID
                root.out.snmptrap.varbind.type_1 = this.trap.VarBinds.index(1).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(1).Type == 4 || this.trap.VarBinds.index(1).Type == 68 {
                  root.out.snmptrap.varbind.value_1 = this.trap.VarBinds.index(1).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_1 = this.trap.VarBinds.index(1).Value.string()
                }
              if this.trap.VarBinds.length() > 2 {
                root.out.snmptrap.varbind.oid_2 = this.trap.VarBinds.index(2).OID
                root.out.snmptrap.varbind.type_2 = this.trap.VarBinds.index(2).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(2).Type == 4 || this.trap.VarBinds.index(2).Type == 68 {
                  root.out.snmptrap.varbind.value_2 = this.trap.VarBinds.index(2).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_2 = this.trap.VarBinds.index(2).Value.string()
                }
              if this.trap.VarBinds.length() > 3 {
                root.out.snmptrap.varbind.oid_3 = this.trap.VarBinds.index(3).OID
                root.out.snmptrap.varbind.type_3 = this.trap.VarBinds.index(3).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(3).Type == 4 || this.trap.VarBinds.index(3).Type == 68 {
                  root.out.snmptrap.varbind.value_3 = this.trap.VarBinds.index(3).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_3 = this.trap.VarBinds.index(3).Value.string()
                }
              if this.trap.VarBinds.length() > 4 {
                root.out.snmptrap.varbind.oid_4 = this.trap.VarBinds.index(4).OID
                root.out.snmptrap.varbind.type_4 = this.trap.VarBinds.index(4).Type.snmp_int_enum_enrich(".1_SnmpTypes")
                if this.trap.VarBinds.index(4).Type == 4 || this.trap.VarBinds.index(4).Type == 68 {
                  root.out.snmptrap.varbind.value_4 = this.trap.VarBinds.index(4).Value.snmp_octet_string()
                } else {
                  root.out.snmptrap.varbind.value_4 = this.trap.VarBinds.index(4).Value.string()
                }
              }}}}}

              root.out.event.class.name = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessDetectionTimeHigh"
              root.out.event.id = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-jnxBfdSessDetectionTimeHigh-unknown"
              root.out.event.category.name = "BFD session detection-time threshold"
              root.out.event.message = "BFD session detection-time exceeded - UNEXPECTED VARBINDS for jnxBfdSessDetectionTimeHigh trap!"
              root.out.event.severity.code = 4
              root.out.event.severity.level = "Warning"

  - processors:
    - label: default
      mapping: |
        #!blobl
        root = this

        if this.trap.exists("VarBinds") && this.trap.VarBinds.length() > 0 {
          root.out.snmptrap.varbind.oid_0 = this.trap.VarBinds.index(0).OID
          root.out.snmptrap.varbind.type_0 = this.trap.VarBinds.index(0).Type.snmp_int_enum_enrich(".1_SnmpTypes")
          if this.trap.VarBinds.index(0).Type == 4 || this.trap.VarBinds.index(0).Type == 68 {
            root.out.snmptrap.varbind.value_0 = this.trap.VarBinds.index(0).Value.snmp_octet_string()
          } else {
            root.out.snmptrap.varbind.value_0 = this.trap.VarBinds.index(0).Value.string()
          }
        if this.trap.VarBinds.length() > 1 {
          root.out.snmptrap.varbind.oid_1 = this.trap.VarBinds.index(1).OID
          root.out.snmptrap.varbind.type_1 = this.trap.VarBinds.index(1).Type.snmp_int_enum_enrich(".1_SnmpTypes")
          if this.trap.VarBinds.index(1).Type == 4 || this.trap.VarBinds.index(1).Type == 68 {
            root.out.snmptrap.varbind.value_1 = this.trap.VarBinds.index(1).Value.snmp_octet_string()
          } else {
            root.out.snmptrap.varbind.value_1 = this.trap.VarBinds.index(1).Value.string()
          }
        if this.trap.VarBinds.length() > 2 {
          root.out.snmptrap.varbind.oid_2 = this.trap.VarBinds.index(2).OID
          root.out.snmptrap.varbind.type_2 = this.trap.VarBinds.index(2).Type.snmp_int_enum_enrich(".1_SnmpTypes")
          if this.trap.VarBinds.index(2).Type == 4 || this.trap.VarBinds.index(2).Type == 68 {
            root.out.snmptrap.varbind.value_2 = this.trap.VarBinds.index(2).Value.snmp_octet_string()
          } else {
            root.out.snmptrap.varbind.value_2 = this.trap.VarBinds.index(2).Value.string()
          }
        if this.trap.VarBinds.length() > 3 {
          root.out.snmptrap.varbind.oid_3 = this.trap.VarBinds.index(3).OID
          root.out.snmptrap.varbind.type_3 = this.trap.VarBinds.index(3).Type.snmp_int_enum_enrich(".1_SnmpTypes")
          if this.trap.VarBinds.index(3).Type == 4 || this.trap.VarBinds.index(3).Type == 68 {
            root.out.snmptrap.varbind.value_3 = this.trap.VarBinds.index(3).Value.snmp_octet_string()
          } else {
            root.out.snmptrap.varbind.value_3 = this.trap.VarBinds.index(3).Value.string()
          }
        if this.trap.VarBinds.length() > 4 {
          root.out.snmptrap.varbind.oid_4 = this.trap.VarBinds.index(4).OID
          root.out.snmptrap.varbind.type_4 = this.trap.VarBinds.index(4).Type.snmp_int_enum_enrich(".1_SnmpTypes")
          if this.trap.VarBinds.index(4).Type == 4 || this.trap.VarBinds.index(4).Type == 68 {
            root.out.snmptrap.varbind.value_4 = this.trap.VarBinds.index(4).Value.snmp_octet_string()
          } else {
            root.out.snmptrap.varbind.value_4 = this.trap.VarBinds.index(4).Value.string()
          }
        }}}}}

        root.out.event.class.name = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-unknown"
        root.out.event.id = "SNMPTRAP-JUNIPER-BFD-MIB-jnxBfdMib-" + this.trap.SpecificTrap.string()
        root.out.event.category.name = "unknown specific trap"
        root.out.event.message = "unknown specific trap " + this.trap.SpecificTrap.string() + " from Juniper JUNIPER-BFD-MIB-jnxBfdMib"
        root.out.event.severity.code = 4
        root.out.event.severity.level = "Warning"
